\chapter{Аналитическая часть}

В данном разделе будут формализованы объекты синтезируемой сцены, определены их геометрические, оптические характеристики, проанализированы существующие алгоритмы, решающие задачу синтеза сложного изображения в контексте моделирования статической сцены расстановки шахматных фигур на шахматной доске.

\section{Формализация задачи и объектов статической сцены}

На рисунке \ref{img:formal} приведена IDEF0 диаграмма формализуемой задачи.

\includeimage
{formal}
{f}
{H}
{\textwidth}
{IDEF0 диаграмма формализуемой задачи}

Сцена состоит из следующего набора объектов.

\begin{enumerate}
	\item Шахматная доска – правильный параллелепипед, на одной из граней которой расположено шахматное поле из 8x8 ячеек в соответствии с правилами ФИДЕ. Размеры шахматной доски по умолчанию константно заданы в программе.
	\item Шахматные фигуры – модели, занимающие ячейки шахматного поля. Параметры шахматных фигур являются константными и задаются на основе заранее созданных сторонними пакетами моделей. Положение и количество не обязательно соответствует правилам шахматной игры, иными словами, в программном обеспечении будет отсутствовать функционал проверки корректности расположения шахматных фигур в соответствии с правилами игры. Оптические характеристики материала фигур определяются задаваемыми пользователями параметрами.
	\item Точечный источник света - имеет заданное положение в пространстве и равномерно излучает во всех направлениях, а интенсивность освещения спадает с расстоянием \cite{kurov:2023}. 
	\item Наблюдатель (камера) характеризуется своим местоположением и направлением взгляда \cite{kurov:2023}, направлением оси вверх.
\end{enumerate}

В рамках технического задания рассматривается пространственное перемещение только таких объектов, как шахматная фигура (а именно, перенос для её постановки в заданную клетку шахматной доски), камера (перенос, поворот), точечный источник света (перенос). Иных пространственных преобразований не предусмотрено.

\section{Анализ способов задания трехмерных моделей}

Модели являются отображением формы и размеров объектов \cite{kurov:2023}. 
Основное назначение модели – правильно отображать форму и размеры определенного объекта \cite{kurov:2023}. 

Существуют три основных формы моделей \cite{kurov:2023}.

\begin{enumerate}
	\item Каркасная (проволочная) модель, которая задает информацию о вершинах и ребрах объекта. Модель не всегда точно передает форму объекта \cite{kurov:2023}.
	\item Поверхностная модель. Поверхность может быть описана аналитически или задана другим способом, например, через отдельные участки поверхности, однако в данной модели не учитывается, с какой стороны находится материал поверхности \cite{kurov:2023}.
	\item Объёмные (твёрдотельные) модели отличаются от поверхностных моделей тем, что к информации о поверхностях добавляется информация о расположении материала, например через хранение информации о направлении внутренней нормали поверхности \cite{kurov:2023}. 
\end{enumerate}

В связи с тем, что каркасная модель не всегда точно передаёт форму объекта, а поверхностная модель не хранит информацию о том, с какой стороны находится материал поверхности, то при разработке программного обеспечения будет использована объёмная модель.

\section{Способ хранения заранее созданных моделей}

Ниже представлены, согласно источнику \cite{formats}, наиболее распространённые форматы представления трёхмерных моделей в виде двоичных или текстовых файлов.

\begin{enumerate}
	\item OBJ — текстовый формат файлов описания геометрии. 
	Формат файла OBJ хранит информацию о трёхмерных моделях, может кодировать геометрию поверхности 3D-модели, а также хранить информацию о цвете и текстуре \cite{formats}.
	\item 3DS – двоичный формат файлов, используемых программой анимации и рендеринга.
	Содержит информацию об объектах, представленных в виде сеток их кинематику (анимацию), а также данные об источниках освещения.
	\item STL — содержит минимум для описания трёхмерных моделей. Информация об объекте хранится как список треугольных граней, которые описывают его поверхность, и их нормалей.
\end{enumerate}

Поскольку форматы представления будут использоваться только для хранения заранее созданных трёхмерных моделей шахматных фигур, а оптические характеристики материала фигур определяются задаваемыми пользователями параметрами, то нет необходимости хранения излишней информации, помимо поверхностей и их нормалей, согласно определению объёмной модели. 

Таким образом, для хранения заранее созданных сторонними пакетами моделей будет использоваться формат STL.

\section{Изменение местоположения в пространстве}

Согласно техническому заданию необходимо изменять местоположение камеры и источника света. Иными словами, необходимо пользователю дать возможность, согласно источнику \cite{kurov:2023}, выполнить перенос в отношении камеры и источника света, а также поворот в отношении камеры, что можно сделать, используя матрицы поворота и переноса в трёхмерном пространстве \cite{kurov:2023}.

Формулы \ref{Mrotx}, \ref{Mroty}, \ref{Mrotz} -- матрицы поворота вокруг соответствующих осей, а \ref{Mmove} -- матрица переноса.

\begin{equation}
	\label{Mrotx}
	M_x(\alpha) = 
	\begin{pmatrix}
		1 & 0 & 0 \\
		0 & cos(\alpha) & -sin(\alpha) \\
		0 & sin(\alpha) & cos(\alpha) 
	\end{pmatrix}
\end{equation}

\begin{equation}
	\label{Mroty}
	M_y(\alpha) = 
	\begin{pmatrix}
		cos(\alpha) & 0 & sin(\alpha) \\
		0 & 1 & 0 \\
		-sin(\alpha) & 0 & cos(\alpha) 
	\end{pmatrix}
\end{equation}

\begin{equation}
	\label{Mrotz}
	M_z(\alpha) = 
	\begin{pmatrix}
		cos(\alpha) & -sin(\alpha) & 0 \\
		sin(\alpha) & cos(\alpha) & 0 \\
		0 & 0 & 1 \\ 
	\end{pmatrix}
\end{equation}

\begin{equation}
	\label{Mmove}
	M(dx, dy, dz) = 
	\begin{pmatrix}
		1 & 0 & 0 & 0 \\
		0 & 1 & 0 & 0 \\
		0 & 0 & 1 & 0 \\
		dx & dy & dz & 1 \\ 
	\end{pmatrix}
\end{equation}

\section{Модели освещения}

\subsection{Диффузное отражение}

Матовые поверхности обладают свойством диффузного отражения, т. е. равномерного по всем направлениям рассеивания света, благодаря чему поверхности визуально имеют одинаковую яркость независимо от угла обзора \cite{kgtomsk}. 
Для таких поверхностей, согласно источнику \cite{kgtomsk}, справедлив закон косинусов Ламберта, устанавливающий соответствие между количеством отраженного света и косинусом угла $\theta$ между направлением $\bar{L}$  на точечный источник света интенсивности $I_p$ и нормалью $\bar{N}$ к поверхности (рисунок \ref{img:lambert_model})

\includeimage
{lambert_model}
{f}
{H}
{0.4\textwidth}
{Падающий свет и нормаль к поверхности}

Интенсивность вычисляется по формуле \ref{lambert}, где $K_d$ - коэффициент диффузного отражения, является константой в диапазоне (0, 1) и зависит от материала.

\begin{equation}
	\label{lambert}
	I_d = I_p \cdot K_d \cdot cos(\theta)
\end{equation}

При этом количество отраженного света не зависит от положения наблюдателя \cite{kgtomsk}.

Поскольку, даже если предмет защищен от прямых лучей, исходящих от точечного источника света, он все равно будет виден из-за наличия рассеянного света, то формулу \ref{lambert} можно модифицировать формулой \ref{lambert1}, где рассеянный свет представлен членом $I_a$, а $K_a$ определяет количество рассеянного света, которое отражается от поверхности предмета \cite{kgtomsk}. 

\begin{equation}
	\label{lambert1}
	I_d = I_a \cdot K_a + I_p \cdot K_d \cdot cos(\theta)
\end{equation}

$cos{(\theta)}$ можно выразить через нормаль к поверхности в точке $\bar{N}$ и исходный луч  с направлением $\bar{L}$ следующим образом (формула \ref{theta1}) \cite{kgmmgtu}.

\begin{equation}
	\label{theta1}
	cos(\theta) = <\bar{N}, \bar{L}> / |\bar{N}| / |\bar{L}|
\end{equation}

\subsection{Зеркальное отражение}

Зеркальное отражение можно получить от любой блестящей поверхности \cite{kgtomsk}. Блестящие поверхности отражают свет неодинаково по всем направлениям \cite{kgtomsk}. 
От идеального зеркала свет отражается только в том направлении, для которого углы падения и отражения совпадают. 
Это означает, что наблюдатель, с направлением взгляда $-\bar{V}$, сможет увидеть зеркально отраженный свет только в том случае, если угол $\alpha$ равен нулю (рисунок \ref{img:phong}) \cite{kgtomsk}.

\includeimage
{phong}
{f}
{H}
{0.3\textwidth}
{Зеркальное отражение}

В модели освещения предложенной Фонгом, быстрое убывание интенсивности описывается функцией $cos^{n}{\alpha}$, где $n$ обычно лежит в диапазоне 1–200, в зависимости от вида поверхности \cite{kgtomsk}. 
В основе модели лежит эмпирическое наблюдение, а не фундаментальное понимание процесса зеркального отражения \cite{kgtomsk}.
Таким образом, интенсивность зеркального отражения $I_s$ определяется по формуле \ref{phong_eq} \cite{kgtomsk}.

\begin{equation}
	\label{phong_eq}
	I_s = I_p \cdot K_s \cdot cos^{n}{\alpha}
\end{equation}

Направление отражённого света можно получить с использованием формулы \ref{refray} \cite{kgmmgtu}.

\begin{equation}
	\label{refray}
	\bar{R} = \bar{L} - 2 * \bar{N} \cdot dot(\bar{N}, \bar{L})
\end{equation}

$cos{(\alpha)}$ можно выразить направление отражённого луча и направления взгляда наблюдателя.

\begin{equation}
	\label{theta}
	cos(\theta) = <\bar{R}, \bar{V}> / |\bar{R}| / |\bar{V}|
\end{equation}

\section{Алгоритм трассировки лучей}

Алгоритм трассировки лучей позволяет решить все задачи второго этапа синтеза изображения \cite{kgmmgtu}. 
Алгоритм основан на одном из положении геометрической оптики, согласно которому луч света распространяется прямолинейно до тех пор, пока не встретится отражающая поверхность или граница среды преломления \cite{kgmmgtu}. 
Алгоритм состоит из следующих этапов.
\begin{enumerate}
	\item от источников излучения исходит по различным направлениям бесчисленное множество первичных лучей;
	\item один из лучей попадает на объект; 
	\item если объект зеркальный, то луч отражается, а часть световой энергии будет поглощена.
	Так, в результате воздействия на объекты первичных лучей, возникают вторичные лучи;
	\item многократно преломляясь и отражаясь, отдельные световые лучи приходят в точку наблюдения. 
\end{enumerate}

Таким образом, изображение формируется некоторым множеством световых лучей.

В данном алгоритме используется \cite{kgtomsk} глобальная модель освещения Уиггеда, при использовании которой интенсивность некоторой точки объекта, с исходной интенсивность точки $C$, коэффициентом отражения $K_r = 1 - K_d$, коэффициентом преломления $K_t$, интенсивностями по отражённому $I_r$ и преломлённому $I_t$ лучам определяется суммарной интенсивностью, представленной в формуле \ref{global}.

\begin{equation}
	\label{global}
	I = I_d \cdot C + I_s + K_r \cdot I_r  + K_t \cdot I_t
\end{equation}

Интенсивность для рассеянного света обычно константа. 
Интенсивности излучений, проходящих по отражённому лучу и по преломлённому, умножают на коэффициент, учитывающий ослабление интенсивности в зависимости от расстояния, пройденного лучом $e^{-\beta d}$ , где $\beta$ – параметр ослабления, учитывающий свойство среды, в которой распространяется луч, а $d$ – пройденное расстояние. 
Поскольку в техническом задании не упоминается преломление луча, то в дальнейшем $K_t  = 0$.


\subsection{Обратная трассировка лучей}

Метод обратной трассировки лучей позволяет сократить перебор световых лучей, поскольку учитываются только те лучи, которые вносят вклад в формирование изображения \cite{kgtomsk}. 
Согласно этому методу отслеживание лучей производится не от источников света, а в обратном направлении – от точки наблюдателя (рисунок \ref{img:raytraice}). Вводится такое понятие как экран - прямоугольник, размерностью эквивалентеный пользовательскому экрану.

\includeimage  
{raytraice}
{f}
{H}
{0.9\textwidth}
{Обратная трассировка лучей}

Алгоритм состоит из следующих этапов.
\begin{enumerate}
	\item от наблюдателя в каждую точку (пиксель) экрана проводится луч;
	\item луч достигает объекта, преломляясь или отражаясь; 
	\item обработка луча прекращается, когда он перестаёт пересекать объекты сцены. 
\end{enumerate}

Обычно количество раз, которое луч может отразиться или переломиться ограничивают тремя значениями \cite{kgtomsk}, что называется максимальной глубиной трассировки.

Согласно исследованию, указанному в источнике \cite{rtresearch}, метод показывает низкую производительность в сравнении с его модификациями по следующим причинам.

\begin{enumerate}
	\item необходимо перебирать каждый объект сцены при поиске пересечения, таким образом временные затраты увеличиваются с ростом количества объектов сцены;
	\item вычисления начинаются заново для каждого пикселя экрана. 
\end{enumerate}

\subsection{Параллельная версия алгоритма обратной трассировки лучей}

Параллельная версия алгоритма обратной трассировки лучей основывается на том наблюдении, что когерентные лучи можно трассировать вместе. Таким образом, имеет место быть многопоточность по данным, где в данного выступают пиксели экрана. Данный алгоритм комбинируется с другими методами \cite{raytraicecompare}.

\subsection{Использование KD-деревьев для вычисления пересечений с поверхностями сцены}

KD-дерево представляет собой бинарное дерево ограничивающих параллелепипедов (\textit{англ.} BoundingBox), вложенных друг в друга \cite{kdtree}. 
Ограничивающий параллелепипед - параллелепипед, одними из вершин которого являются максимальные и минимальные компоненты координат модели. Каждую из граней можно представить как двумерный отсекатель Кируса-Бека для параметрически заданного отрезка \cite{rogers} (рисунок \ref{img:boundingbox}).

\includeimage  
{boundingbox}
{f}
{H}
{0.7\textwidth}
{Ограничивающий параллелепипед}

Параметрическое уравнение отрезка с параметром $t$  и точками $P_1$, $P_2$ имеет вид, представленный в формуле \ref{param}.

\begin{equation}
	\label{param}
	P(t) = P_1 + (P_2 - P_1) \cdot t
\end{equation}

Соответственно, если $t < 0$, то точка $P$ находится за точкой $P_1$, если $0 \leq t \leq 1$, то точка находится между точками $P_1$ и $P_2$, а если $t > 1$, то точка находится за $P_2$. Рисунок иллюстрирует зависимость расположения точек $P$ от параметра $t$ относительно точек $P_1$, $P_2$.

В случае обратного алгоритма трассировки лучей, рассматривается луч, точка $P_1 = O$ --  местоположение камеры (O -- origin), $(P_2 - P_1) = D$ -- направление взгляда (D -- direction). 

В таком случае, уравнение \ref{param} имеет следующий вид (формула \ref{paramline}).

\begin{equation}
	\label{paramline}
	P(t) =  \bar{O} + \bar{D} \cdot t
\end{equation}

В случае пересечения луча с параллелепипедом, поскольку известны вершины параллелепипеда, то $t$ можно выразить, используя формулу \ref{t}.

\begin{equation}
	\label{t}
	t = (P - \bar{O}) / \bar{D}
\end{equation}

В случае же,  если же направление вектора $\bar{D}$ отрицательно, то необходимо рассматривать обратное расположение вершин параллелепипеда \cite{rogers}.

Соответственно, поскольку находится пересечение с каждой гранью параллелепипеда, то будет получено до 6 различных пересечений с гранями, три из которых будет связано с минимальными координатами относительно направления луча, а три с максимальными.
Необходимыми $t$ будут максимальная среди трёх минимальных и минимальная среди трёх максимальных.
Однако, существует два случая, когда луч не пересекает параллелепипед, которые можно выяснить при вычислении $t$.

\begin{enumerate}
	\item оба $t$ оказались отрицательными -- луч находится за пределами параллелепипеда и направлен в противоположную сторону;
	\item минимальное $t$ оказалось больше максимального -- луч находится за пределами параллелепипеда;
\end{enumerate}

\includeimage  
{tparams}
{f}
{H}
{0.7\textwidth}
{Пример пересения луча с одной граней параллелепипеда}

Для определения пересечения с треугольными гранями, используемых в STL представлении модели, можно использовать барицентрическую систему координат \cite{kdtree}.

Пусть есть треугольник, заданный своими вершинами $a$, $b$ и $c$. 
Тогда этот треугольник является выпуклой оболочкой этих точек. 
Это значит, что для любой точки $p$ из этого треугольника всегда найдутся три числа $u$, $v$ и $w$ такие, что верная система уравнений \ref{baricenter} \cite{kdtree}.

\begin{equation}
	\label{baricenter}
	\begin{cases}
		p = a \cdot u + v · b + w \cdot c \\
		u, v, w > 0 \\
		u + v + w = 1
	\end{cases}
\end{equation}

Числа u, v и w называются барицентрическими координатами точки $p$. 
При этом сами вершины треугольника будут иметь координаты (1, 0, 0),(0, 1, 0) и (0, 0, 1) \cite{kdtree}. 
Если точка p лежит строго внутри треугольника, то все компоненты ее барицентрических координат будут принадлежать интервалу (0, 1) \cite{kdtree}.
У точек на ребрах одна из трех координат будет равной нулю \cite{kdtree}.

Соответственно, если дана точка $p$, то её барицентрические координаты можно определить следующим образом.

\begin{equation}
	w = 1 - u -v
\end{equation}

\begin{equation}
	\label{barstep1}
	p = u \cdot (a - c) + v \cdot (b - c)
\end{equation}

Умножая уравнение \ref{barstep1} скалярно на $a - c$ и $b - c$, получится система алгебраических уравнений \ref{barstep2}.

\begin{equation}
	\label{barstep2}
	\begin{cases}
	u(a - c, a - c) + v(a - c, b - c) = (p - c, a - c) \\	
	u(a - c, b - c) + v(b - c, b - c) = (p - c, b - c)
	\end{cases}
\end{equation}

Определитель системы \ref{barstep2} выражается формулой \ref{barstep3}.

\begin{equation}
	\label{barstep3}
	d = (a - c, a - c)(b - c, b - c) - (a - c, b - c)^2
\end{equation}

Решение системы определяется правилу Крамера (формула \ref{barstep4}).

\begin{equation}
	\label{barstep4}
	\begin{cases}
		u = 1 / d \cdot ((p - c, a - c)(b - c, b - c) - (p - c, b - c)(a - c, b - c)) \\	
		v = 1 / d \cdot ((p - c, a - c)(a - c, b - c) - (p - c, b - c)(a - c, a - c))
	\end{cases}
\end{equation}

Каждый параллелепипед в KD-дереве разбивается плоскостью, перпендикулярной одной из осей координат, на два дочерних параллелепипеда (условно, левый и правый) в зависимости от того, к какой из стороны разбиения центр фигуры, заключённой внутри каждого параллелепипеда, находится ближе. 
Вся сцена целиком содержится внутри корневого параллелепипеда, но, продолжая рекурсивное разбиение параллелепипедов, можно прийти к тому, что в каждом листовом параллелепипеде будет содержаться небольшое число примитивов \cite{kdtree}. 
Таким образом, KD-дерево позволяет использовать бинарный поиск для нахождения примитива, пересекаемого лучом \cite{kdtree}.
Недостатком алгоритма является трудоёмкость построения дерева \cite{raytraicecompare}.

\subsection{Выбор методов и алгоритмов}

Хотя при использовании KD-дерева необходимо учитывать трудоёмкость добавления элемента в дерево и время, необходимое для его построения, согласно техническому заданию требуется обеспечить добавление и удаление объектов со сцены (добавление и удаление шахматных фигур), что приводит к увеличению количества объектов сцены, и как, следствие, росту временных затрат. Таким образом, недостаток алгоритма уступает оптимизации обратного алгоритма трассировки лучей с точки зрения поиска пересечения с поверхностями, что позволяет его в дальнейшем использовать при разработке программного обеспечения.

Поскольку параллельная версия алгоритма обратной трассировки лучей комбинируется с другими оптимизациями данного алгоритма, то данную версию алгоритма можно также использовать с KD-деревьями.

\section*{Вывод}

В данном разделе была формализована задача, формализованы объекты синтезируемой сцены, определены их геометрические, оптические характеристики, проанализированы существующие алгоритмы, решающие задачу синтеза сложного изображения в контексте моделирования статической сцены расстановки шахматных фигур на шахматной доске.

Основным алгоритмом была выбрана параллельная версия алгоритма обратной трассировки лучей с использованием KD-деревьев для вычисления пересечений с поверхностями сцены.

























\chapter{Конструкторская часть}

В данном разделе будет формально описана декомпозиция разрабатываемого ПО с формальным описанием всех используемых алгоритмов.

\section{Декомпозиция разрабатываемого ПО}

На рисунке \ref{img:allinitprocess} приведена BPMN-диаграмма процесса инициализации статической сцены расстановки шахматных фигур на шахматной доске на основании введённого пользователем количества фигур.

\includeimage  
{allinitprocess}
{f}
{H}
{0.7\textwidth}
{BPMN-диаграмма процесса инициализации статической сцены расстановки шахматных фигур на шахматной доске на основании введённого пользователем количества фигур}

На рисунке \ref{img:addmodel} приведена BPMN-диаграмма процесса добавления шахматной фигуры.

\includeimage  
{addmodel}
{f}
{H}
{0.7\textwidth}
{BPMN-диаграмма процесса добавления шахматной фигуры}

На рисунке \ref{img:removemodel} приведена BPMN-диаграмма процесса удаления шахматной фигуры со сцены.

\includeimage  
{removemodel}
{f}
{H}
{0.7\textwidth}
{BPMN-диаграмма процесса удаления шахматной фигуры со сцены}

На рисунке \ref{img:spector} приведена BPMN-диаграмма процесса изменения спектральных характеристик объектов сцены.

\includeimage  
{spector}
{f}
{H}
{0.7\textwidth}
{BPMN-диаграмма процесса изменения спектральных характеристик объектов сцены}

На рисунке \ref{img:move} приведена BPMN-диаграмма изменения местоположения объектов сцены.

\includeimage  
{move}
{f}
{H}
{0.7\textwidth}
{BPMN-диаграмма процесса изменения местоположения объектов сцены}

\subsection{Структуры данных}

В алгоритме обратной трассировки лучей необходимо, чтобы, в случае пересечения, была известна информация о точке пересечения (для построения отражённого луча), а также информация о спектральных характеристиках материала. 
Поскольку при поиске пересечения в дальнейшем необходимо определять, присутствует ли в узле KD-дерева ещё одно KD-дерево, то необходимо иметь информацию об объекте соответственно.Также необходимо, что бы узлы дерева хранили информацию о левых и правых поддеревьях, ограничивающий параллелепипед, а также направление о оси, по которой произошла декомпозиция параллелепипеда и параметры самого ограничивающего параллелепипеда.

Таким образом, возникает необходимость наличия следующих структур (в понятии как совокупность данных) для дальнейшего упрощения описания схем алгоритмов.

\begin{itemize}
	\item Ray - луч, исходящий из камеры, создаётся функцией Ray(origin, direction), хранит две данные: начало луча (origin) b его направление (direction);
	\item Material - структура данных, хранящая информацию о спектральных характеристиках поверхности (ambient -- рассеянное излучение, diffuse -- диффузная составляющая интенсивности поверхности, reflection -- коэффициент отражения, p - коэффициент качества полировки);
	\item Hitinfo - структура хранит необходимую информацию о пересечении: t -- значение параметра при пересечнии с объектом, material -- структура Material, hit\_point - значение точки пересечения в декартовой системе координат;
	\item Point - структура, хранящая информацию о координате в декартовой системе координат (данные x, y, z);
	\item BoundingBox - структура, хранящая информация об ограничивающем параллелепипеде, содержит две структуры Point, в одной из которых записаны минимальные значения координат объекта (min), а в другой максимальные (max);
	\item KDNode - узел KD-дерева, хранит необходимую информацию об узле: left, right - узлы, могут иметь значение null в случае, если узел лиственный, axis - ось, в направлении которой была выполнена декомпозиция ограничивающего параллелепипеда, bx - структура BoundingBox ограничивающего параллелепипеда, objects - массив объектов лиственного узла, size - количество объектов в objects;
	\item Object - структура, которая хранит объект сцены или поверхность (data), центр объекта (center) а также его соответствующий ограничивающий параллелепипед (bx).
\end{itemize}

Доступ к данным структур в дальнейшем будет обозначен с использованием оператора «.», однако в действительности доступ к данным структуры зависит от выбора средств реализации.

\section{Камера}

Рассмотрим камеру как структуру данных.

Камера должна хранить несколько данных: местоположение камеры, направление взгляда, а также необходимо заранее определить, как ость относительное камеры смотрит вверх. 
К данным, описывающим камеру в случае обратной трассировки лучей, относятся также соотношение сторон используемого экрана, а также угол $fov$ -- областью видимости. 
Считается, что достоверное изображение можно получить, если $fov = 60^\circ$ по вертикали \cite{kgmmgtu}.
Пусть вверх смотрит ось z.


\subsection{Вычисление луча из камеры в экран}

Пусть необходимо получить луч из местоположения камеры в точку, соответствующую пиксель $(i, j)$, а отношение ширины и высоты экрана равно $k$, середина экрана -- display\_center, местоположение камеры -- center.

 Расстояние от камеры до экрана -- $d$. $tg(fov) = height / 2 / d $, из чего следует $height = 2 * tg(fov) \cdot d$. 
 Пусть $d = 1$. 
 Тогда $height = 2 \cdot tg(fov)$. 
 Поскольку $k = width / height$, то $width = height \cdot k $. 
 
 Однако, местоположение экрана зависит от направления взгляда ($look\_up$) камеры и оси, которая направлена вверх относительно неё $up$. 
 Тем не менее, горизонтальная составляющая экрана должна быть направлена перпендикулярно оси, направленной верх, и направляю взгляда, что можно получить из векторного произведения $horizontal = [look\_up, up]$. 
 Аналогично вертикальная составляющая $vertical = [horizontal, look\_up]$. 
 
 Если рассматривать $hotizontal$ и $vertical$ как единицы размерности экрана, то для получения реальных экранных высоты и ширины необходимо каждую из составляющих домножить на $width$ и $height$ соответственно. 
 
 Для вычисления пикселя согласно его номеру по ширине и высоте на пользовательском объекте-изображении необходимо ввести точку начала отсчёта. Пусть это будет нижний левый угол экрана, который можно получить следующим образом: $left\_button = loop\_up - (vertical + horizontal) / 2$.
 
 Таким образом, объект необходимого луча $Ray(center,  left\_button + i * horizontal + j * vertical)$.
 
 На рисунке \ref{img:camera} приведена используемая модель камеры.
 
 \includeimage  
 {camera}
 {f}
 {H}
 {0.6\textwidth}
 {Используемая модель камеры}

\section{KD-дерево}

Поскольку каждый объект сцены состоит из множества треугольных поверхностей, то его можно представить как отдельное KD-дерево, а поскольку любое KD-дерево имеет глобальный ограничивающий параллелепипед, то совокупность объектов сцены можно представить как KD-дерево, состоящее из KD-поддеревьев.

\subsection{Алгоритм построения KD-дерева}

На рисунке \ref{img:createkd} приведена схема алгоритма построения KD-дерева.

\includeimage  
{createkd}
{f}
{H}
{\textwidth}
{Схема алгоритма построения KD-дерева}

\subsection{Алгоритм поиска пересечения в KD-дереве}

На рисунке \ref{img:search} приведена схема алгоритма поиска пересечения в KD-дерева.

\includeimage  
{search}
{f}
{H}
{0.95\textwidth}
{Схема алгоритма поиска пересечения в KD-дерева}

\subsection{Алгоритм добавления объекта в KD-дерево}

На рисунке \ref{img:addtokd} приведена схема алгоритма добавления объекта в KD-дерево.

\includeimage  
{addtokd}
{f}
{H}
{0.95\textwidth}
{Схема алгоритма добавления объекта в KD-дерево}

\subsection{Алгоритм удаления объекта из KD-дерева}

Удаление из KD-дерева можно производить с учётом того, что будет удаляться шахматная фигура с доски согласно заданным пользователем координатам, иначе говоря, параметры ограничивающего параллелепипеда заранее известны.

Пусть ось z направлена вверх, а шахматная доска располагается параллельно плоскости z = 0 и ниже плоскости относительно направления оси z плоскости z = 0, в то время как нижняя грань ограничивающих параллелепипедов расположена в плоскости z = 0. 
В таком случае, поскольку на доске не может быть в одной клетке более одной фигуры, то достаточно найти фигуру, нижняя грань которой соотносится с ведёнными параметрами клети на шахматной доске.

На рисунке \ref{img:deletefromkd} приведена схема алгоритма удаления объекта из KD-дерева.

\includeimage  
{deletefromkd}
{f}
{H}
{0.7\textwidth}
{Схема алгоритма добавления объекта в KD-дерево}
 
\subsection{Алгоритм поиска пересечения с плоскостью, ограниченной треугольником}

\section{Обратная трассировка лучей}

На рисунке \ref{img:raytraiceschema} приведена схемы алгоритмов отрисовки одного луча и перебора координат объекта-изображения, выводимого пользователю.

\includeimage  
{raytraiceschema}
{f}
{H}
{0.8\textwidth}
{Схемы алгоритмов отрисовки одного луча и перебора координат объекта-изображения, выводимого пользователю}

\section*{Вывод}

В данном разделе была будет формально описана декомпозиция разрабатываемого ПО с формальным описанием всех используемых алгоритмов.

